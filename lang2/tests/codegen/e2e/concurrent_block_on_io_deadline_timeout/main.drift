module m

import std.concurrent as conc;
import std.core as core;
import lang.thread as thread;

pub fn main() nothrow -> Int {
	val fd = thread.test_eventfd_create();
	var t = conc.spawn_cb(core.callback0(| | captures(copy fd) nothrow => {
		conc.block_on_io(fd, 1, 1);
		return 9;
	}));
	var res = t.join_timeout(conc.Duration(millis = 50));
	match res {
		Ok(v) => { return v; },
		Err(_) => { return 1; },
		default => { return 2; }
	}
}
