module m

import std.concurrent as conc;
import std.core as core;
import std.net as net;
import lang.thread as thread;

pub fn main() nothrow -> Int {
	val fd = thread.test_eventfd_create();
	var s = net.tcp_stream(fd);
	var t = conc.spawn_cb(core.callback0(| | captures(copy s) nothrow => {
		s.block_on_write(0);
		return 9;
	}));
	thread.vt_park_until(5);
	thread.test_eventfd_write(fd, 1);
	var res = t.join();
	match res {
		Ok(v) => { return v; },
		Err(_) => { return 1; },
		default => { return 2; }
	}
}
