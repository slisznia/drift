module m

import std.concurrent as conc;
import std.core as core;
import lang.thread as thread;

pub fn main() nothrow -> Int {
	val fd = thread.test_eventfd_create();
	var t = conc.spawn_cb(core.callback0(| | captures(copy fd) nothrow => {
		conc.block_on_io(fd, 1, 50);
		return 9;
	}));
	thread.vt_park_until(5);
	thread.test_eventfd_write(fd, 1);
	var res = t.join();
	match res {
		Ok(v) => { return v; },
		Err(_) => { return 1; },
		default => { return 2; }
	}
}
